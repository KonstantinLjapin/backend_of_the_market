```mermaid
# market_backend

Бэкенд маркетплейса на FastAPI с поддержкой современных технологий.

## Технологии
- Python 3.12
- FastAPI
- Poetry (управление зависимостями)
- Ruff (линтер)
- PostgreSQL (основная БД)
- Redis (кэширование и очереди)
- Elasticsearch (поиск)
- Docker (контейнеризация)

## Ключевые функции

### 1. Аутентификация и безопасность
- **Многофакторная аутентификация**  
  Подтверждение email/телефона, OAuth2 для соцсетей
- **RBAC (ролевая модель)**  
  Управление правами администраторов (суперадмин, модератор, аналитик)
- **Защита данных**  
  Хеширование паролей (bcrypt), SSL/TLS, валидация против XSS/SQL-инъекций
- **Сессионное управление**  
  JWT-токены, автоматический вход для доверенных устройств

### 2. Управление пользователями
- **Регистрация/верификация**  
  Валидация документов продавцов через API ФНС
- **Блокировка/разблокировка**  
  Система модерации с историей нарушений
- **Профили**  
  Единый профиль для мультиролей (покупатель/продавец)

### 3. Товары и каталог
- **CRUD для товаров**  
  Генерация штрих-кодов (python-barcode)
- **Динамические категории**  
  Древовидная структура с неограниченной вложенностью
- **Модерация контента**  
  Автоматическая проверка изображений (CV)

### 4. Транзакции и платежи
graph LR
  A[Покупатель] --> B[Платежный шлюз]
  B --> C{Проверка PCI DSS}
  C -->|Успех| D[Списание средств]
  D --> E[Зачисление на escrow-счёт]
  E --> F[Выплата продавцу]
Интеграция с PSP
Stripe, CloudPayments, Сбербанк API

Выплаты продавцам
Автоматические/ручные переводы

Система возвратов
Автоматическая отмена заказов

5. Заказы и логистика
Real-time трекинг
Интеграция с API СДЭК/Boxberry

Уведомления
WebSocket/Push для статусов заказов

Расчёт ETA
Прогнозирование времени доставки

6. Аналитика и отчёты
Тип отчёта	Частота	Технологии
Анализ продаж	Реал-тайм	ClickHouse
Трафик	Ежедневно	Google Analytics
Эффективность акций	Еженедельно	Python ML
7. Маркетинговые инструменты
Гибкие скидки

Таргетирование баннеров
Сегментация по поведению пользователей

Автоуведомления
Оповещение продавцов об акциях

8. Коммуникации
In-app чат
Архитектура:

text
Клиент → WebSocket → Redis Pub/Sub → Celery → БД
Тикеты поддержки
Система приоритетов (Critical/High/Medium/Low)

9. Системные функции
Elasticsearch
Полнотекстовый поиск с фильтрами

Кэширование
Redis для каталога товаров

Асинхронные задачи
Celery для:

Генерации отчётов

Обработки изображений

Массовых уведомлений

Архитектура
plaintext
┌─────────────────┐       ┌────────────────┐       ┌───────────────┐
│   Клиенты       │──────▶│   Nginx        │──────▶│   FastAPI     │
│   (Web/Mobile)  │◀──────│   (Firewall)   │◀──────│   Monolith    │
└─────────────────┘       └────────────────┘       └───────┬───────┘
                                                           │
                                                           ▼
┌───────────────────────────────────────────────────────┐
│                   Уровень данных                      │
│  ┌──────────┐    ┌─────────┐    ┌─────────────────┐   │
│  │PostgreSQL│    │ Redis   │    │ MinIO/S3        │   │
│  └──────────┘    └─────────┘    └─────────────────┘   │
└───────────────────────────────────────────────────────┘
Безопасность
Rate Limiting
100 запросов/мин с IP

CSP Headers
Запрет исполнения inline-скриптов

Аудит действий
Логирование операций:

json
{
  "action": "block_user",
  "target": "seller_12345",
  "executor": "admin_007",
  "timestamp": "2023-11-20T14:23:43Z"
}
Запуск проекта
Быстрый старт (Docker)
bash
# Даем права на выполнение скрипта
chmod +x {name}_test.sh

# Запускаем проект (автоочистка после завершения)
./{name}_test.sh

# Проверка работоспособности
curl http://127.0.0.1:8080/ping
Для разработчиков
Установите зависимости:

bash
poetry env use python3.12
poetry install
Настройте окружение:

bash
mkdir src
poetry install --no-root
Основные команды:

bash
# Активировать окружение
poetry shell

# Добавить зависимость
poetry add package-name

# Запустить линтер
poetry run ruff check . --fix

# Запустить приложение
poetry run python src/main.py
Холодный старт
bash
poetry init -n --python "^3.12"
poetry config virtualenvs.in-project true
poetry env use python3.12
mkdir src
poetry install --no-root
Требования
Python 3.12

Poetry (установка: официальная инструкция)

Docker (для запуска через контейнеры)